<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../img/S4L.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>


    <link rel="stylesheet" href="./../css/dashboards.css">

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body onload="refreshGrafico(); historico()">
    <header>
        <a href="../index.html"><img class="logo" src="../img/S4L.png" alt=""></a>
        <nav class="nav-bar">
            <ul>
                <a class="links" href="../index.html">
                    <li>Inicio</li>
                </a>
                <a class="links" href="../index.html">
                    <li>Sobre o Projeto</li>
                </a>
                <a class="links" href="../index.html">
                    <li>Equipe</li>
                </a>
                <a class="links" href="../simulador.html">
                    <li>Calcular peso</li>
                </a>
                <a class="links" href="../index.html">
                    <li>Contato</li>
                </a>
            </ul>
            <ul>
                <div class="btn-logout" onclick="limparSessao()">
                    <h3>Sair</h3>
                </div>
            </ul>
        </nav>
    </header>
    <div id="container">
        <canvas id="GraficoBarras" class="grafico1_estatisticas"></canvas>
        <div class="lateral">
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span></h3>
            </div>
        </div>
    </div>
</body>

</html>
<script>

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    var chart = null;  // inicializando a variável chart no escopo global, pois ela será verificada num if mais abaixo

    function historico() {
        fetch("/estatistica/historico", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO fetchRanking!");

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);
                    var respostaBanco = json; // Armazenando o JSON que veio como resposta do fetch numa variável local
                });
            } else {
                console.log("Houve um erro ao capturar as ultimas pesagens");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }
        }).catch(function (erro) {
            console.log(erro);
        });

        return false;
    }

    function fetchGrafico() {

        fetch("/estatistica/estatisticasUsuario", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO fetchGrafico!");

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);

                    var respostaBanco = json; // Armazenando o JSON que veio como resposta do fetch numa variável local

                    atualizarGrafico(respostaBanco); // Chamando a função que atualiza o gráfico, passando a variável local como parâmetro para evitar a criação de uma variável global
                });
            } else {
                console.log("Houve um erro ao capturar os dados do gráfico!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }
        }).catch(function (erro) {
            console.log(erro);
        });

        return false;
    }

    function refreshHistorico() {
        historico(); // Chama a função uma vez
        setInterval(historico(), 5000); // Chama a função de 30 em 30 segundos, para que o gráfico seja constantemente atualizado
    }

    function refreshGrafico() {
        fetchGrafico(); // Chama a função uma vez
        setInterval(fetchGrafico(), 5000); // Chama a função de 30 em 30 segundos, para que o gráfico seja constantemente atualizado
    }


    function atualizarGrafico(dados) { // Esta função espera 1 parâmetro, que aqui se chamará "dados"
        const labels = ['Peso', 'Meta de Peso']; // Constante para definir os labels, que são fixamente apenas esses dois
        var dadosGrafico = 0; // Separando os dados para o gráfico com base no parâmetro recebido por esta função

        if (chart) { // Verificando se um gráfico já existe, ou seja, se há conteúdo na variável -> Esse é o motivo da variável "chart" ser global
            chart.destroy(); // Destruindo o gráfico se a condição for cumprida
        }


        for (var i = 0; i <= dados.length - 1; i++) {
            dadosGrafico = [dados[i].pesoUsuario, dados[i].metaPeso];

        }

        const ctx = document.getElementById('GraficoBarras').getContext('2d');
        chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ["Peso", "Meta Peso"],
                    datasets: [{
                        data: dadosGrafico,
                        backgroundColor: ['#dce738cb', '#a26edfcb'],
                        borderColor: ['rgba(54, 162, 235, 1)'],
                        borderWidth: 0.5
                    }]
                },
                options: {
                    aspectRatio: 1.5
                }
            });

    }
</script>